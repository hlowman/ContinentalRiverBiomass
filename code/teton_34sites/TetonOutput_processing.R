## 34 rivers data output from Teton
## Created: August 5, 2021
## Heili Lowman

# The following code will do some preliminary examination of the output
# of the 34 site dataset sent to Teton and run through the Ricker model
# earlier this week.

# Load packages
lapply(c("plyr","dplyr","ggplot2","cowplot",
         "lubridate","tidyverse", "reshape2",
         "PerformanceAnalytics","jpeg","grid",
         "rstan","bayesplot","shinystan", "here",
         "ggrepel", "patchwork"), require, character.only=T)

##############################
## Data Import & Processing ##
##############################

# Load dataset loaded into Teton.
data_in <- readRDS("data_working/df_34sites.rds")

# Load dataset generated by Teton (this is a biggie).
data_out <- readRDS("data_teton/stan_34rivers_output_Ricker_2021_08_03.rds")

# Load dataset with site information.
data_info <- readRDS("data_working/NWIS_34sitesinfo_subset.rds")

# Make sure shinystan is working properly by testing at one site.
launch_shinystan(data_out$nwis_01608500)
# It is working! Although I am getting an error message suggesting I trim
# the data down a bit before launching Shiny STAN.

# Make sure we can extract parameters by testing at one site.
test_params <- extract(data_out$nwis_01608500, c("r","lambda","s","c",
                                                 "B","P","pred_GPP","sig_p","sig_o"))
# Yay - this works too!

# Going to create a function of the above to pull out data of interest from
# all sites.
extract_params <- function(x){
  df <- x
  extract(df, c("r","lambda","s","c"))
}

# And now map this to the entire output list.
data_out_params <- map(data_out, extract_params)

# And create a dataframe
data_out_params_df <- map_df(data_out_params, ~as.data.frame(.x), .id="site_name") %>%
  # and add "K" to it.
  mutate(k = (-1*r)/lambda)

# And now to calculate means by site.
data_means <- data_out_params_df %>%
  group_by(site_name) %>%
  summarize(r_mean = mean(r),
            k_mean = mean(k),
            s_mean = mean(s),
            c_mean = mean(c))

# And now to bind the values with site attributes.
data_together <- left_join(data_means, data_info, by = "site_name")

##############################
##          Figures         ##
##############################

# Basic plot of r values vs. stream order.
# fig1 <- ggplot(data_together, aes(x = NHD_STREAMORDE, y = mean_r, fill = NHD_STREAMORDE)) +
#   geom_point(shape = 21, size = 4, alpha = 0.75) +
#   labs(x = "NHD Stream Order",
#        y = "Maximum Growth Rate (r)") +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# fig1

# three outliers - right to left - are Black Earth Creek WI, Reedy Creek FL, and Au Sable River FL

# ggsave(plot = fig1,
#        filename = "figures/teton_34sites/fig1_r_strord.jpg",
#        width = 8,
#        height = 6)

# fig2 <- ggplot(data_together, aes(x = NHD_STREAMORDE, y = mean_k, fill = NHD_STREAMORDE)) +
#   geom_point(shape = 21, size = 4, alpha = 0.75) +
#   labs(x = "NHD Stream Order",
#        y = "Carrying Capacity (k)") +
#   theme_bw() +
#   theme(legend.position = "none")
# 
# fig2

# outlier is again Reedy Creek FL

# ggsave(plot = fig2,
#        filename = "figures/teton_34sites/fig2_k_strord.jpg",
#        width = 8,
#        height = 6)

# After updating the code on Aug 12, here are some additional figures.
# First, a quick pairs plot.
fig_pairs <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  select(r_mean, k_mean, s_mean, c_mean, NHD_STREAMORDE) %>%
  pairs()

# Now, to plot the growth parameters.
fig3a <- ggplot(data_together, aes(x = r_mean, y = k_mean, 
                                  fill = site_name, label = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Maximum Growth Rate (r)",
       y = "Carrying Capacity (K)",
       title = "Full Dataset") +
  geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig3a

# Removing negative r and K values.
fig3b <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = r_mean, y = k_mean, 
             fill = site_name, label = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Maximum Growth Rate (r)",
       y = "Carrying Capacity (K)",
       title = "Negative Values Removed") +
  geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig3b

# Panel by stream order with negative growth parameters removed
fig3c <- data_together %>%
    filter(r_mean > 0) %>%
    filter(k_mean > 0) %>%
    ggplot(aes(x = r_mean, y = k_mean, fill = site_name)) +
    geom_point(shape = 21, size = 4, alpha = 0.75) +
    labs(x = "Maximum Growth Rate (r)",
         y = "Carrying Capacity (K)",
         title = "Paneled by Stream Order - Negative Values Removed") +
    facet_wrap(~NHD_STREAMORDE, scales = "free", ncol = 4)+
    #geom_text_repel(size=3) +
    theme_bw() +
    theme(legend.position = "none")

fig3c

# creating composite figure for export
full_fig3 <- (fig3a + fig3b) / fig3c 

full_fig3

# ggsave(full_fig3,
#        filename = "figures/teton_34sites/k_vs_r.jpg",
#        width = 8,
#        height = 8)

# and exploring disturbance metrics
fig4a <- ggplot(data_together, aes(x = c_mean, y = s_mean, 
                                   fill = site_name, label = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Critical Discharge (c)",
       y = "Steepness of Persistence Curve (s)",
       title = "Full Dataset") +
  geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig4a

# Removing negative r and K values.
fig4b <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = c_mean, y = s_mean, 
             fill = site_name, label = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Critical Discharge (c)",
       y = "Steepness of Persistence Curve (s)",
       title = "Negative Values Removed") +
  geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig4b

# Panel by stream order with negative growth parameters removed
fig4c <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = c_mean, y = s_mean, fill = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Critical Discharge (c)",
       y = "Steepness of Persistence Curve (s)",
       title = "Paneled by Stream Order - Negative Values Removed") +
  facet_wrap(~NHD_STREAMORDE, scales = "free", ncol = 4)+
  theme_bw() +
  theme(legend.position = "none")

fig4c

# creating composite figure for export
full_fig4 <- (fig4a + fig4b) / fig4c 

full_fig4

# ggsave(full_fig4,
#        filename = "figures/teton_34sites/s_vs_c.jpg",
#        width = 8,
#        height = 8)

# Now, to compare growth and disturbance parameters
# r vs. c
fig5a <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = c_mean, y = r_mean, 
             fill = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Critical Discharge (c)",
       y = "Maximum Growth Rate (r)",
       title = "Negative r & K Values Removed from All") +
  #geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig5a

# r vs. s
fig5b <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = s_mean, y = r_mean, 
             fill = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Steepness of Persistence Curve (s)",
       y = "Maximum Growth Rate (r)") +
  #geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig5b

# k vs. c
fig5c <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = c_mean, y = k_mean, 
             fill = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Critical Discharge (c)",
       y = "Carrying Capacity (K)") +
  #geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig5c

# k vs. s
fig5d <- data_together %>%
  filter(r_mean > 0) %>%
  filter(k_mean > 0) %>%
  ggplot(aes(x = s_mean, y = k_mean, 
             fill = site_name)) +
  geom_point(shape = 21, size = 4, alpha = 0.75) +
  labs(x = "Steepness of Persistence Curve (s)",
       y = "Carrying Capacity (K)") +
  #geom_text_repel(size=3) +
  theme_bw() +
  theme(legend.position = "none")

fig5d

full_fig5 <- (fig5a + fig5b) / (fig5c + fig5d)

full_fig5

# ggsave(full_fig5,
#        filename = "figures/teton_34sites/rk_vs_cs.jpg",
#        width = 8,
#        height = 8)

###################################################
## Check other covariate data quality
###################################################

plotting_covar <- function(x) {
  
  # create a dataframe at each site
  df.1 <- x
  
  # join with site information
  df <- left_join(df.1, data_info, by = "site_name")
  
  # create a vector of the available years of data
  years <- unique(df$year)
  
  # loop over each year of data
  for(z in years){
    
    # subset the data by year
    subset <- subset(df, year == z) # subset the larger dataset by each year
    
    # create a 4-paneled plot with gross primary production, discharge, temperature, and light
    # a.k.a. data inputs (prior to fitting the model)
    p <- plot_grid(
    
    ggplot(subset, aes(date, GPP))+
      geom_point(color="chartreuse4", size=2)+
      geom_errorbar(aes(ymin = GPP.lower, ymax = GPP.upper), width=0.2,color="darkolivegreen4")+
      labs(y=expression('GPP (g '*~O[2]~ m^-2~d^-1*')'), 
           title = df$long_name.y[1],
           subtitle = df$site_name[1])+
      theme(legend.position = "none",
            panel.background = element_rect(color = "black", fill=NA, size=1),
            axis.title.x = element_blank(), axis.text.x = element_blank(),
            axis.text.y = element_text(size=12),
            axis.title.y = element_text(size=12)),
    
    ggplot(subset, aes(date, Q))+
      geom_line(size=1.5, color="deepskyblue4")+
      labs(y="Q (cms)")+
      theme(legend.position = "none",
            panel.background = element_rect(color = "black", fill=NA, size=1),
            axis.title.x = element_blank(), axis.text.x = element_blank(),
            axis.text.y = element_text(size=12),
            axis.title.y = element_text(size=12)),
    
    ggplot(subset, aes(date, temp))+
      geom_line(size=1.5, color="#A11F22")+
      labs(y="Water Temp (C)")+
      theme(legend.position = "none",
            panel.background = element_rect(color = "black", fill=NA, size=1),
            axis.title.x = element_blank(), axis.text.x = element_blank(),
            axis.text.y = element_text(size=12),
            axis.title.y = element_text(size=12)),
    
    ggplot(subset, aes(date, light))+
      geom_point(size=2, color="darkgoldenrod3")+
      labs(y="Incoming Light", x="Date")+
      theme(legend.position = "none",
            panel.background = element_rect(color = "black", fill=NA, size=1),
            axis.text = element_text(size=12),
            axis.title = element_text(size=12)),
    ncol=1, align="hv")
  
  # display plots
  print(p) 
  
  # save and export plots
  file.name <- paste0("figures/teton_34sites/site_covariate_plots/",df$site_name[1],"_",z,"_covar.jpg",sep = "") # create file name
  
  # set specifications for size and resolution of your figure
  ggsave(p,
         filename = file.name,
         width = 8,
         height = 6)
  
  } # close out for-loop
  
} # close out function

# test to be sure the function works at a single site
plotting_covar(data_in$nwis_02266200)

# And now map this to the entire data_in list.
map(data_in, plotting_covar)

# End of script.
