---
title: "Productivity Modeling - Revised Results"
author: "Heili Lowman, Joanna Blaszczak"
date: "10/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Predicting River Resilience to Disturbance Using Population Models at a Continental Scale

#### Purpose Statement

**We are interested in learning about streams' responses to disturbance (*i.e.*, storm events). Using a state-space time series approach, we are fitting a logistic population growth model to gross primary production estimates to gain information about growth parameters (*i.e.*, maximum growth rate, critical disturbance thresholds) that describe algal population dynamics and compare results across stream sites.**

------------------------------------------------------------------------

##### Updated Hypotheses

***Q~1~:*** **How does maximum growth rate (r~max~) vary in streams and rivers across the country as a function of flow disturbance and light availability?**

*H~1A~*: The maximum growth rate will be greatest in streams with fewer **flow disturbance** events that scour existing biomass, since gross primary production (GPP) tends to be highest in streams with more predictable flow [(Bernhardt et al., 2022)](https://www.pnas.org/doi/10.1073/pnas.2121976119).

*H~1B~*: As **light availability** increases, the maximum growth rate will increase, since GPP tends to be highest in well-lit streams [(Bernhardt et al., 2022)](https://www.pnas.org/doi/10.1073/pnas.2121976119).

***Q~2~:*** **How does the critical discharge threshold at which biomass is removed (c) vary in streams and rivers across the country as a function of flow disturbance and dominant watershed land use?**

*H~2A~*: The critical discharge threshold will be greatest in streams with fewer **flow disturbance** events that scour existing biomass, since these sites will have likely higher maximum growth rates (*see H~1A~*) and higher GPP overall.

*H~2B~*: As **land use** changes relative to undeveloped watersheds, the critical discharge threshold will change according to how the dominant land use in a watershed changes flow regimes. In predominantly forested or undeveloped watersheds, critical discharge thresholds will be greater, because flow will be less flashy and more predictable [(Poff et al., 2006)](https://www.sciencedirect.com/science/article/abs/pii/S0169555X06002546). In predominantly urban watersheds, critical discharge thresholds will be lower, because flow will be flashier and less predictable, in large part due to higher impervious land cover [(Blaszczak et al., 2019)](https://doi-org.unr.idm.oclc.org/10.1002/lno.11081).

```{r fig1, fig.show = "hold", out.width = "50%", echo = FALSE, fig.cap = "Figure 1. Hypothesized structural equation model with primary covariates included in this project. Sources denoted numerically can be found listed at the end of this document."}

knitr::include_graphics(here::here("figures", "teton_fall22", "SEMa.jpg"))

knitr::include_graphics(here::here("figures", "teton_fall22", "SEMb.jpg"))

```

------------------------------------------------------------------------

##### Model Structure

A conceptual diagram of the model structure used may be found in Figure 1.

Since our last meeting, we experimented with structuring the model in a hierarchical format so as to share information across sites. However, this approach ended up being too computationally intensive, so we have reverted to modeling each site individually.

```{r fig2, fig.align = "left", out.width = "100%", echo = FALSE, fig.cap = "Figure 2. The state-space population model being used to estimate parameters of maximum growth rate (r~max~) across individual stream sites. The observation model uses daily estimates of gross primary production (g~t~) and daily light (L~t~) to estimate daily biomass (b~t~). The daily persistence term (P~t~) is a function of daily discharge (Q~t~) which is used to estimate the sensitivity of the persistence transition from presence to removal of biomass (s) and the critical discharge threshold at which benthic biomass is removed (c). Both the observation and persistence models then inform the process model, which is a density-dependent growth function for daily biomass (b~t~) in a given stream. The estimated terms of P~t~ and b~t~ are input into the process model to extract values for the maximum growth rate (r~max~) and lambda(Î»), which is equal to the negative maximum growth rate divided by the carrying capacity (K)."}

knitr::include_graphics(here::here("figures", "teton_fall22", "model_structure.jpg"))

```

------------------------------------------------------------------------

##### Data Acquisition

Data have been assembled using the datasets available in [Appling et al., 2018](https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982), [Blaszczak et al., 2021](https://www.sciencebase.gov/catalog/item/606f60afd34ef99870188ee5), [Bernhardt et al., 2022](https://github.com/streampulse/metabolism_synthesis), and [Savoy and Harvey, 2021](https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168).

We have filtered the available data according to the following rules:

-   Filter for high-quality sites based on model diagnostics (e.g., K~600~ sigma $\hat{R}$ \< 1.05, GPP \< 0 or ER \> 0 for more than 15% of estimates).
-   Filter for sites that have a maximum time gap of **14** days and a minimum of **90** days per year of daily GPP estimates.
-   Any GPP estimates below zero were assigned a value between 0.05 and 0.13.

From the initial 356 river sites in the Appling dataset, our filtered dataset consists of **182 sites** and **691 site-years** of data (Table 1).

```{r tab1, fig.align = "center", echo = FALSE, out.width = "75%", fig.cap = "Table 1. Summary statistics for all 182 stream sites included in the dataset."}

knitr::include_graphics(here::here("figures", "teton_fall22", "summary_data_table_101222.png"))

```

------------------------------------------------------------------------

##### Results

Figures of all available covariates (discharge, temperature, light) as well as the full set of our model diagnostics are available to view on a separate R Shiny application located [here](https://hlowman.shinyapps.io/shiny/). Below are a few overview figures examining initial relationships among model parameter values and site covariates as well as predicted gross primary productivity (GPP) using model estimated parameters.

Prior to plotting, all sites whose maximum growth rate parameter (r~max~) estimates were negative (i.e., not biologically feasible) or r~max~ had an $\hat{R}$ value greater than 1.05 have been removed (n = 159 sites remaining).

**Main Takeaway #1:** Maximum growth rate (r~max~) values tend to be greater in less frequently disturbed streams (i.e., with lower coefficient of variation in discharge values, Fig. 2C).

```{r fig3, fig.align = "left", fig.cap = "Figure 3. Plots of median maximum growth rates as (A) an overall distribution across all sites and versus (B) mean daily gross primary production (GPP), (C) the coefficient of variation in discharge (CV~Q~), (D) daily mean light availability, (E) cumulative summer light availability, (F) mean daily summer water temperature, (G) stream width, (H) catchment size, (I) relative influence of dams (0 value indicating certain influence of a given structure), (J) road density in the catchment (km/km^2), and (K) percent impervious land cover in the catchment.", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_fall22", "rmax_12panel.jpg"))

```

Typically, the model performs well when predicting declines in GPP (due to its design), but it underpredicts the rate at which these systems recover following disturbance.

```{r fig4, fig.align = "left", fig.cap = "Figure 4. A comparison of gross primary productivity (GPP) estimates used during the initial model fit (dark green points) versus re-predicted GPP values using our model parameter estimates (light green line with 2.5% and 97.5% confidence intervals shaded). Note, this represents only one site (N.E. Anacostia River in Riverdale, MD) for one year (2011).", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_fall22", "GPP_predGPP_nwis01649500.jpg"))

```

Prior to plotting, all sites whose critical disturbance threshold (c) estimates were negative (i.e., not hydrologically feasible) or c had an $\hat{R}$ value greater than 1.05 have been removed (n = 141 sites remaining).

**Main Takeaway #2:** In most streams, the discharge threshold at which biomass is disturbed occurs far more frequently than the two-year flood.

```{r fig5, fig.align = "left", fig.cap = "Figure 5. Plots of the ratio of the critical discharge (Q~c~) to the two-year flood (Q~2yr~) as (A) an overall distribution across all sites and versus (B) the coefficient of variation in discharge (CV~Q~), (C)daily mean light availability, (D) stream order, (E) site latitude, (F) site longitude, (G) watershed size, and (H) primary land use. Note, the horizontal black line indicates when the Q~c~:Q~2yr~ ratio value is one; values below this line indicate the critical discharge threshold at a given site falls below the 2 year flood discharge value.", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_fall22", "QcQ2_8panel.jpg"))

```

*Next Steps:* Following this meeting, we intend to pursue two main activities:

(1) Finalize model diagnostics to determine the list of sites included in the results/discussion.

(2) Finish a first draft of the manuscript by the end of the calendar year. Please see the working Google document [here](https://docs.google.com/document/d/1nEprXJPd_erMg4H_T6A78iqWB-HS8ICVqk4aCBRiiNg/edit?usp=sharing).

------------------------------------------------------------------------

##### **Questions for You:**

(1) Do you have any suggestions regarding model diagnostic best practices?

(2) How should we caveat sites that are on the same river? If they are assigned different USGS site IDs, is that sufficient to say they are encountering different enough environmental conditions?

(3) Do you feel there are particular figures that should/shouldn't be included in the main text?

(4) Do you feel a multiple linear regression using parameter values (r, c) and the covariates provided above is the best approach for a post-hoc analysis? Would creating a structural equation model be a better approach?

(5) Is there anything else you feel I should consider examining moving forward?

------------------------------------------------------------------------

##### *Supplementary Figures*

```{r suppfig1, fig.align = "left", out.width = "100%", echo = FALSE, fig.cap = "Supplementary Figure 1. Persistence curves for a site that performs well with the model structure described above (South Branch Potomac River) and a site that performs poorly (Reedy Creek). The critical discharge at which biomass is disturbed (c) is denoted by the dotted vertical line. The sensitivity of the persistence transition from presence to removal of biomass (s) is equal to the slope of the green persistence curve as it transitions from complete persistence (P = 1) to removal (P = 0) of biomass."}

knitr::include_graphics(here::here("figures", "presentations", "p_curves.png"))

```

##### *Sources for Figure 1*

(1)[Bernhardt et al., 2022](https://www.pnas.org/doi/10.1073/pnas.2121976119) (2)[Vannote et al., 1980](https://cdnsciencepub.com/doi/10.1139/f80-017) (3)[Acuna et al., 2004](https://doi.org/10.1111/j.1365-2427.2004.01239.x) (4)[Roberts et al., 2007](https://doi.org/10.1007/s10021-007-9059-2) 
(5)[O'Connor et al., 2012](https://doi.org/10.1029/2011WR011488) 
(6)[Beaulieu et al., 2013](https://doi.org/10.1111/fwb.12097) 
(7)[Reisinger et al., 2017](https://doi.org/10.1002/ecs2.1776) 
(8)[Poff et al., 2006](https://www.sciencedirect.com/science/article/abs/pii/S0169555X06002546) 
(9)[Hill and Dimick, 2002](https://doi.org/10.1046/j.1365-2427.2002.00837.x) (10)[Mulholland et al., 2008](https://doi.org/10.1038/nature06686) 
(11)[Fisher et al., 1982](https://doi.org/10.2307/2937346) 
(12)[Uehlinger 2006](https://doi.org/10.1111/j.1365-2427.2006.01551.x) 
(13)[Marzolf et al., 2021](https://doi.org/10.1002/lno.11707) 
(14)[Blaszczak et al., 2019](https://doi-org.unr.idm.oclc.org/10.1002/lno.11081) (15)[Hall et al., 2015](https://doi.org/10.1002/lno.10031) 
(16)[Doyle et al., 2005](https://doi.org/10.1029/2005WR004222) 
(17)[Savoy et al., 2021](https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168) 
(18)[McTammany et al., 2007](https://doi.org/10.1899/06-092.1)

###### End of RMarkdown document.
