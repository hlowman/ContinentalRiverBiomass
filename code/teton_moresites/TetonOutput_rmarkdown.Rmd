---
title: "Productivity Modeling - Intermediate Results"
author: "Heili Lowman, Joanna Blaszczak"
date: "2/14/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Continental Stream Productivity Modeling

#### Purpose Statement

**We are interested in learning about streams' responses to disturbance (i.e., storm events). Specifically, we are fitting a logistic population growth model to gross primary production estimates so that we can gain information about growth parameters (e.g., maximum growth rate) that describe algal population dynamics and compare results across stream sites.**

***

##### Revised Hypotheses

**How does the maximum growth rate (r) and carrying capacity (K) vary in streams and rivers across the country as a function of stream order, disturbance, and light availability?**

*H~1~*: As **stream order** increases, the maximum growth rate will decrease (due to size, water depth, light attenuation and sediment load in water) and the carrying capacity will increase (due to size and space availability).

*H~2~*: The maximum growth rate will be greatest in streams with regular **disturbance** events that scour existing biomass. Carrying capacity will be altered if the regular **disturbances** are of large enough scale to alter the physical structure of the stream (e.g., could decrease due to infill with sediment or increase due to increase in surface area).

*H~3~*: As **light availability** increases, the maximum growth rate will increase (photoinhibition will likely not be a concern except in intermittent/ephemeral and low order streams) and the carrying capacity will also increase (up until a certain point, where the demand for light is fulfilled and no space remains).

***

##### Model Structure

A conceptual diagram of the model structure used may be found in Figure 1, and changes made to the model since our last meeting are described in Figure 2 and Figure 4.

```{r model structure, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 1. The state-space population model being used to estimate parameters of maximum growth rate (r) and carrying capacity (K) across individual stream sites. The observation model uses daily estimates of gross primary production (g) and daily light (L) to estimate daily biomass (B). The daily persistence term (P) is a function of daily discharge (Q) which is used to estimate the sensitivity of the persistence transition from presence to removal of biomass (s) and the critical discharge threshold at which benthic biomass is removed (c). Both the observation and persistence models then inform the process model, which is a density-dependent growth function for daily biomass (B) in a given stream. The estimated terms of P and B are input into the process model to extract values for the maximum growth rate (r) and lambda, which is equal to the maximum growth rate divided by the carrying capacity (K)."}

knitr::include_graphics(here::here("figures", "presentations", "model_screenshot.png"))

```

```{r reinitialization, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 2. For every gap in a time series greater than 14 days, we have instituted a re-initialization rule. Rather than having the daily biomass (B) be a function of the biomass the day before, we re-initialize the model and set the biomass on that day to be function of the gross primary production estimate and the light data for that same day. Then, the model is allowed to proceed using the process model structure presented in Figure 1."}

knitr::include_graphics(here::here("figures", "presentations", "reinitialization_screenshot.png"))

```

```{r P curves, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 3. Persistence curves for a site that performs well with the model structure described above (South Branch Potomac River) and a site that performs poorly (Reedy Creek). The critical discharge at which biomass is disturbed (c) is denoted by the dotted vertical line. The sensitivity of the persistence transition from presence to removal of biomass (s) is equal to the slope of the green persistence curve as it transitions from complete persistence (P = 1) to removal (P = 0) of biomass."}

knitr::include_graphics(here::here("figures", "presentations", "p_curves.png"))

```

```{r P removal, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 4. For sites that perform poorly with the model structure presented in Figure 1, we have begun removing the persistence (P) term, as well as associated parameters (s and c) from the model. The removal of the P term currently depends upon model diagnostics from initially running the model structure presented in Figure 1. The figure above demonstrates the effect that P term removal has on gross primary production (GPP) predictions at a site that performs well with the original model (South Branch Potomac River) and at a site that performs poorly (Reedy Creek)."}

knitr::include_graphics(here::here("figures", "supp_figures", "nwis_01608500_02266300_with_without_P.png"))

```

***

##### Data Acquisition

Data have been assembled using the datasets available in [Appling et al., 2018](https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982), [Blaszczak et al., 2021](https://www.sciencebase.gov/catalog/item/606f60afd34ef99870188ee5), and [Savoy and Harvey, 2021](https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168).

We have revised the following rules to filter the available data:

- Filter for high-quality sites based on model diagnostics (e.g., K600 sigma Rhat < 1.05, GPP < 0 or ER > 0 for more than 25% of estimates).
- Filter for sites that have a maximum time gap of **14** days and a minimum of **90** days per year of GPP data.
- Any GPP estimates below zero were assigned a value between 0.05 and 0.13.
- For sites that did not have stream light data available from Savoy and Harvey, 2021, light values were set to **surface PAR**.

From the initial 356 river sites in the Appling dataset, our filtered dataset consists of **207 sites** and **784 site-years** of data (Figures 5 and 6).

```{r summary stream stats, fig.align = "center", fig.cap = "Figure 5. Summary statistics of (A) stream order and (B) years of data all 207 stream sites included in the dataset. Note, years refers to calendar years represented in the dataset, with a minimum of 90 days of data required within a given year.", out.width = "75%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "order_years_207sites.png"))

```

```{r geography, fig.align = "center", fig.cap = "Figure 6. Map of all 207 stream sites included in the dataset, colored by stream order. Note, one site in Alaska is not pictured. ", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "map_207sites.png"))

```

***

##### Revised Results

Figures of all available covariates (discharge, temperature, light) as well as the full set of our model diagnostics are available to view on a separate R Shiny application located [here](https://hlowman.shinyapps.io/shiny/). Below are a few overview figures examining initial relationships among model parameter values and between parameters and stream order (*H~1~*).

```{r results1, fig.align = "center", fig.cap = "Figure 7. Plots of mean maximum growth rates (r) and the log of mean carrying capacities (K) for individual sites colored by (A) the model structure used and (B) Pearson's correlation coefficient values. Note, 9 sites with negative mean r and K values have been removed.", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "r_k_allsites_bothmodels_cc.jpg"))

```

```{r results2, fig.align = "center", fig.cap = "Figure 8. Boxplots of (A) mean maximum growth rates (r) and (B) mean carrying capacities (K) for individual sites grouped by stream order. Note, the same 9 sites that were removed from Figure 6 have been removed from these panels.", out.width = "80%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "r_k_strord2.jpg"))

```

*Next Steps:* Following this meeting, we intend to pursue two main revisions to the model structure:

(1) We intend to add a random effect for site in order to pool information across sites.

(2) We intend to explore alternate methods of inclusion for the persistence term (P) using sparse modeling methods that would also pool information across sites and likely decrease computational time.

***

##### Questions for You:

(1) Do you feel the dataset is sufficiently large to proceed with analyses?

(2) Do you feel we should remove the persistence term (P) from the model based on other criteria?

(3) Is there anything else you feel I should consider examining moving forward?

###### End of RMarkdown document.

***
