---
title: "Productivity Modeling - Intermediate Results"
author: "Heili Lowman, Joanna Blaszczak"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Continental Stream Productivity Modeling

The following document walks through the next iteration of the results of applying the logistic growth primary productivity model initially developed by Blaszczak et al. (*in prep*) to stream sites across the continental United States.

*Note: If you would like to be added to the GitHub repository that currently houses the below code, please contact Heili at hlowman at unr.edu. Everyone is welcome to join the repo as a collaborator!*

***

##### Revised Hypotheses

**How does the maximum growth rate (r) and carrying capacity (K) vary in streams and rivers across the country as a function of stream order, disturbance, and light availability?**

*H~1~*: As **stream order** increases, the maximum growth rate will decrease (due to size, water depth, light attenuation and sediment load in water) and the carrying capacity will increase (due to size and space availability).

*H~2~*: The maximum growth rate will be greatest in streams with regular **disturbance** events that scour existing biomass. Carrying capacity will be altered if the regular **disturbances** are of large enough scale to alter the physical structure of the stream (e.g., could decrease due to infill with sediment or increase due to increase in surface area).

*H~3~*: As **light availability** increases, the maximum growth rate will increase (photoinhibition will likely not be a concern except in intermittent/ephemeral and low order streams) and the carrying capacity will also increase (up until a certain point, where the demand for light is fulfilled and no space remains).

***

##### Model Structure

A conceptual diagram of the model structure used may be found in *Figure 1*, and changes made to the model since our last meeting are described in *Figure 2* and *Figure 3*.

```{r model structure, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 1. The state-space population model being used to estimate parameters of maximum growth rate (r) and carrying capacity (K) across individual stream sites. The observation model uses daily estimates of gross primary production (g) and daily light (L) to estimate daily biomass (B). The daily persistence term (P) is a function of daily discharge (Q) which is used to estimate the sensitivity of the persistence transition from presence to removal of biomass (s) and the critical discharge threshold at which benthic biomass is removed (c). Both the observation and persistence models then inform the process model, which is a density-dependent growth function for daily biomass (B) in a given stream. The estimated terms of P and B are fit to this model to extract values for the maximum growth rate (r) and lambda, which is equal to the maximum growth rate divided by the carrying capacity (K)."}

knitr::include_graphics(here::here("figures", "presentations", "model_screenshot.png"))

```

```{r reinitialization, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 2. For every gap in a time series greater than 14 days, we have instituted a re-initialization rule. Rather than having the daily biomass (B) be a function of the biomass the day before, we re-initialize the model and set the biomass on that day to be function of the gross primary production estimate and the light data for that same day. Then, the model is allowed to proceed using the process model structure shown in Figure 1."}

knitr::include_graphics(here::here("figures", "presentations", "reinitialization_screenshot.png"))

```

```{r P removal, fig.align = "center", out.width = "75%", echo = FALSE, fig.cap = "Figure 3. For sites that perform poorly with the model structure presented in Figure 1, we have begun removing the persistence (P) term, as well as associated parameters (s and c) from the model. The figure above demonstrates the effect that P term removal has on gross primary production (GPP) predictions at a site that performs well with the original model (South Branch Potomac River) and at a site that performs poorly (Reedy Creek). Note, GPP minima are better predicted at the South Branch Potomac River site when P is included. However, inclusion of the P term does not appear to affect GPP predictions for the Reedy Creek site."}

knitr::include_graphics(here::here("figures", "supp_figures", "nwis_01608500_02266300_with_without_P.png"))

```

***

##### Data Acquisition

Data have been assembled using the datasets available in [Appling et al., 2018](https://www.sciencebase.gov/catalog/item/59bff507e4b091459a5e0982), [Blaszczak et al., 2021](https://www.sciencebase.gov/catalog/item/606f60afd34ef99870188ee5), and [Savoy and Harvey, 2021](https://www.sciencebase.gov/catalog/item/5f974adfd34e198cb77db168).

We have revised the following rules to filter the available data:

- Filter for high-quality sites based on model diagnostics (e.g., K600 sigma Rhat < 1.05, GPP < 0 or ER > 0 for more than 25% of estimates).
- Filter for sites that have a maximum time gap of **14** days and a minimum of **90** days per year of GPP data.
- Any GPP estimates below zero were assigned a value between 0.05 and 0.13.
- For sites that did not have stream light data available from Savoy and Harvey, 2021, light values were set to **surface PAR**.

From the initial 356 river sites in the Appling dataset, our filtered dataset consists of **207 sites** and **784 site-years** of data (Figure 4).

```{r summary stream stats, fig.align = "center", fig.cap = "Figure 4. Summary statistics of (A) stream order and (B) years of data all 207 stream sites included in the dataset. Note - years refers to calendar years represented in the dataset, with a minimum of 90 days of data required within a given year.", out.width = "75%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "order_years_207sites.png"))

```

```{r geography, fig.align = "center", fig.cap = "Figure 5. Map of all 207 stream sites included in the dataset, colored by stream order. Note - one site in Alaska is not pictured. ", out.width = "100%", echo = FALSE}

knitr::include_graphics(here::here("figures", "teton_moresites", "map_207sites.png"))

```

***

##### Revised Results

Figures of all available covariates (by site-year) as well as the full set of our model diagnostics are available to view on a separate R Shiny application located [here](https://hlowman.shinyapps.io/shiny/). Below are a few overview figures examining initial relationships among model parameter values and between parameters and stream order.

```{r results1, fig.align = "center", fig.cap = "Figure 6. Boxplots of (A) mean maximum growth rates (r) and (B) mean carrying capacities (K) for individual sites grouped by stream order as well as (C) mean maximum growth rates plotted against mean carrying capacities.", echo = FALSE}

#knitr::include_graphics(here::here("figures", "teton_34sites", "r_k_paneled.jpg"))

```

*Next Steps:* Following this meeting, we intend to re-fit the model with a random effect for year in order to pool information across sites.

***

##### Questions for You:

(1) Do you feel the dataset is sufficiently large to proceed with analyses?

(2) Should we be removing the persistence term (P) from the model based on other criteria?

(3) Is there anything else you feel I should consider examining moving forward?

###### End of RMarkdown document.

***
