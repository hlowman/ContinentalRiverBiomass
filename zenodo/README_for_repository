Dataset title: Data and Code for Lowman et al. "Macroscale controls determine the recovery of river ecosystem productivity following flood disturbances" 

Creators: Heili E. Lowman (University of Nevada Reno), Robert Shriver (University of Nevada Reno), Robert O. Hall Jr. (Flathead Lake Biological Station), Judson Harvey (U.S. Geological Survey), Phil Savoy (U.S. Geological Survey), Charles Yackulic (U.S. Geological Survey), Joanna R. Blaszczak (University of Nevada Reno)

Contact: Heili Lowman (heili.lowman@gmail.com)

Keywords: Ecosystem recovery, disturbance, river, algae, ecosystem metabolism

Funding: This research was supported by the Modelscape Consortium, funded by the National Science Foundation’s Established Program to Stimulate Competitive Research (EPSCoR) award #OIA-2019528.

Timeframe of Data: January 2007 - December 2016

Geographic Location of Data: United States of America

###

Data Provenance: Data for this project were downloaded from multiple published data sources including:

Appling, A.P., Read, J.S., Winslow, L.A., Arroita, M., Bernhardt, E.S., Griffiths, N.A., Hall, R.O., Jr., Harvey, J.W., Heffernan, J.B., Stanley, E.H., Stets, E.G., and Yackulic, C.B., 2018, Metabolism estimates for 356 U.S. rivers (2007-2017): U.S. Geological Survey data release, https://doi.org/10.5066/F70864KX.

Blaszczak, J.R., Koenig, L.E., Mejia, F.H., Gómez-Gener, L., Dutton, C.L., Carter, A.M., Grimm, N.B., Harvey, J.W., Helton, A.M., Cohen, M.J., Anyanwu, E.D., Pokrovsky, O.S., Krickov, I.V., Manasypov, R.M., Vorobyev, S.N., and Serikova, S., 2021, Distribution, frequency, and global extent of hypoxia in rivers: U.S. Geological Survey data release, https://doi.org/10.5066/P99X6SIR.

Bernhardt, E.S., Savoy, P., Vlah, M.J., Appling, A.P., Koenig, L.E., Hall Jr., R.O., Arroita, M., Blaszczak, J.R., Carter, A.C., Cohen, M., Harvey, J.W., Heffernan, J.B., Helton, A.M., Hosen, J.D., Kirk, L., McDowell, W.H., Stanley, E.H., Yackulic, C., and Grimm, N.B., 2022 Light and flow regimes regulate the metabolism of rivers. Proc. Natl. Acad. Sci. U.S.A. 119, e2121976119. (Data available at https://github.com/streampulse/metabolism_synthesis)

Note: Daily discharge data for each river from 1970-01-01 to 2020-12-31 and dissolved nutrient data for available rivers from 2007-01-01 to 2017-12-31 measured by the USGS were downloaded using the 'dataRetrieval' package in R.

Data Availability: Due to the many intermediate steps and the size of the biomass model outputs, not all generated datasets have been archived in this project. Instead, here we provide an envisioned workflow and details regarding data availability for anyone planning to work through these scripts -- 

Scripts have been numbered in the order in which they should be run. Links to download raw datasets necessary to work through scripts 01, 02, and 03 are provided. The compiled list of raw data used to fit the model in scripts 04 parts 1 - 4 is published here (list_181sites_Qmaxnorm_SavoySL.rds). The data loaded into script 05 is too large to publish (available upon request), but the outputs from this script are published here (beartooth_181rivers_model_params_all_iterations_050823.rds, beartooth_181rivers_model_diags_050923.rds). These data should allow users to work through scripts 06, 07, 08, 09, 10, 11, and 12. The data generated by script 12 and necessary for scripts 13, 14, and 15 are published here (amax_covariates_143sites_110723.rds, Qc_covariates_130sites_110723.rds). If you would like copies of any of the remaining intermediate datasets or have any further questions, please do not hesitate to reach out to H. Lowman.

###

Data Files

#
File name: list_181sites_Qmaxnorm_SavoySL.rds
File description: List of the assembled raw data, including daily gross primary production estimates, light at the stream surface, and USGS discharge measurements, used to fit the latent biomass model at 181 stream sites.

Column name | Description | Unit or Code explanation or date format | missing value code

site_name | USGS NWIS Site Identifier | NA | NA
date | Date | yyyy-mm-dd | NA
GPP | Daily gross primary productivity estimates | gO2 m^-2 d^-1 | NA
GPP.lower | 2.5th quantile of daily gross primary productivity estimate | gO2 m^-2 d^-1 | NA
GPP.upper | 97.5th quantile of daily gross primary productivity estimate | gO2 m^-2 d^-1 | NA
GPP.Rhat | Gelman-Rubin convergence statistic | NA | NA
ER | Daily ecosystem respiration estimate | gO2 m^-2 d^-1 | NA
ER.lower | 2.5th quantile of daily ecosystem respiration estimate | gO2 m^-2 d^-1 | NA
ER.upper | 97.5th quantile of daily ecosystem respiration estimate | gO2 m^-2 d^-1 | NA
K600 | Daily reaeration rate coefficient estimate | d^-1 | NA
K600.lower | 2.5th quantile of daily reaeration rate coefficient estimate | d^-1 | NA
K600.upper | 97.5th quantile of daily reaeration rate coefficient estimate | d^-1 | NA
temp | Mean daily water temperature | degrees Celsius | NA
Q | Mean daily discharge | m^3 s^-1 | NA
light | Mean daily downwards shortwave radiation flux | W m^-2 | NA
velocity | Mean daily water velocity | m s^-1 | NA
doy | Julian day | NA | NA
year | Year | yyyy | NA
site_year | Year appended to the NWIS code | NA | NA
GPP_temp | duplicate of GPP column | gO2 m^-2 d^-1 | NA
long_name | Full USGS Site Name | NA | NA
Date | Date-time | yyyy-mm-dd hh:mm:ss | NA
DOY | duplicate of doy column | NA | NA
Year | duplicate of year column | yyyy | NA
PAR_surface | Daily sum of PAR estimated at the stream surface | mol m^-2 d^-1 | NA
GPP_sd | Standard deviation of gross primary productivity estimate | gO2 m^-2 d^-1 | NA
diff_time | Number of days since last day of data available | d | NA
seq | Time frame sequence assignment based on day to day differences | NA | NA
new_e | Delineation of new time frame events based on sequence assignments | | NA
index | Additional site index number | NA | NA
Ndays | Number of days in site record | d | NA
light_rel | Daily light relative to maximum light in record | NA | NA
Q_rel | Daily discharge relative to maximum discharge in record | NA | NA

#
File name: beartooth_181rivers_model_params_all_iterations_050823.rds
File description: List of latent biomass model outputs including all iterations (n = 7500) for all site-level parameters (r, lambda, c, s) for all stream sites (n = 181). Estimated daily parameters (e.g., biomass) not included due to file size but available upon request.

Column name | Description | Unit or Code explanation or date format | missing value code

r | Maximum growth rate parameter estimate | NA | NA
lambda | Lambda parameter estimate | NA | NA
s | Sensitivity parameter estimate | NA | NA
c | Critical disturbance flow threshold parameter estimate | NA | NA
sig_p | Process error estimate | NA | NA
sig_o | Observation error estimate | NA | NA

#
File name: beartooth_181rivers_model_diags_050923.rds
File description: Latent biomass model diagnostics for site-level parameters for all stream sites.

Column name | Description | Unit or Code explanation or date format | missing value code

site_name | USGS NWIS Site Identifier | NA | NA
parameter | Site-level parameter estimated | NA | NA
mean | Mean estimated parameter value | NA | NA
se_mean | Standard error of estimated parameter value | NA | NA
sd | Standard deviation of estimated parameter value | NA | NA
2.5% | 2.5th quantile of estimated parameter value | NA | NA
97.5% | 97.5th quantile of estimated parameter value | NA | NA
n_eff | Estimated effective sample size of estimated parameter value | NA | NA
Rhat | Gelman-Rubin convergence statistic of estimated parameter value | NA | NA

#
File name: amax_covariates_143sites_110723.rds
File description: Maximum algal yield estimates (and confidence intervals) as well as macroscale site covariates for sites that passed model diagnostic filtering steps (n = 143). These data are used to fit the posthoc bayesian regression models.

Column name | Description | Unit or Code explanation or date format | missing value code

site_name | USGS NWIS Site Identifier | NA | NA
parameter | Site-level parameter estimated | NA | NA
mean | Mean estimated parameter value | NA | NA
se_mean | Standard error of estimated parameter value | NA | NA
sd | Standard deviation of estimated parameter value | NA | NA
2.5% | 2.5th quantile of estimated parameter value | NA | NA
97.5% | 97.5th quantile of estimated parameter value | NA | NA
n_eff | Estimated effective sample size of estimated parameter value | NA | NA
Rhat | Gelman-Rubin convergence statistic of estimated parameter value | NA | NA
r_med | Median estimated maximum growth rate value | NA | NA
yield_med | Median estimated maximum algal yield value | NA | NA
yield_2.5 | 2.5th quantile of estimated maximum algal yield value | NA | NA
yield_97.5 | 97.5th quantile of estimated maximum algal yield value | NA | NA
lambda_med | Median estimated lambda value | NA | NA
yield_2.5_ed | 2.5th quantile of estimated maximum algal yield values with negative values set equal to zero | NA | NA
cvQ | Coefficient of variation in discharge over the full site record | NA | NA
meanLight | Mean daily light availability over the full site record | mol m^-2 d^-1 | NA
meanTemp | Mean daily water temperature over the full site record | degrees Celsius | NA
meanGPP | Mean daily gross primary productivity over the full site record | gO2 m^-2 d^-1 | NA
Lat_WGS84 | Site Latitude (datum = WGS84) | Decimal degrees | NA
Lon_WGS84 | Site Longitude (datum = WGS84) | Decimal degrees | NA
Order | NHDPlus V2 modified Strahler Stream Order | NA | NA
NHD_AREASQKM | NHDPlus V2 local catchment area | km^2 | NA
LU_category | Google earth engine land use category (based on IGBP classification) | agricultural, barren, forested, grassland, urban, water, wetland | NA
NHD_RdDensCat | StreamCat density of roads within catchment (2010 Census Tiger Lines) | km/km^2 | NA
NHD_RdDensWs | StreamCat density of roads within upstream watershed (2010 Census Tiger Lines) | km/km^2 | NA
NHD_PctImp2011Cat | StreamCat mean percent imperviousness of anthropogenic surfaces within catchment (NLCD 2011) | percent | NA
NHD_PctImp2011Ws | StreamCat mean percent imperviousness of anthropogenic surfaces within upstream watershed (NLCD 2011) | percent | NA
dvqcoefs.a | Hydraulic geometry coefficient, a, where width = aQ^b | NA | NA
dvqcoefs.b | Hydraulic geometry coefficient, b, where width = aQ^b | NA | NA
Canal | NHDPlus V2 flag for presence of upstream canal or ditch where values indicate the quantile distance of daily average distances to 80% oxygen turnover beyond which the feature is present | NA | NA
Dam | USACE_NID flag for presence of upstream dam where values indicate the quantile of daily average distances to 80% oxygen turnover at or beyond which the feature is present | NA | NA
width_med | Median stream width | m | NA
Nitrate | Mean dissolved nitrate concentration based on available USGS data | mg/L NO3-N | NA
Phosphorus | Mean dissolved phosphorus concentration based on available USGS data | mg/L P | NA
agency_cd | Nutrient monitoring agency code | NA | NA
site_no | USGS Site Identifier | NA | NA
huc_2 | USGS Hydrologic Unit Code (HUC) for region | NA | NA
total_exc_events | Total number of events during which discharge exceeded estimated flow disturbance threshold (Qc) | NA | NA
total_exc_days | Total number of days during which discharge exceeded estimated flow disturbance threshold (Qc) | d | NA
total_days | Total number of days in site record | d | NA
total_exc_rel_d | Total number of days during which discharge exceeded estimated flow disturbance threshold (Qc) relative to total days in the site record | percent | NA
years | Number of unique calendar years in a site record | y | NA
exc_y | Total number of events during which discharge exceeded estimated flow disturbance threshold (Qc) relative to number of unique calendar years in a site record | y^-1 | NA

#
File name: Qc_covariates_130sites_110723.rds
File description: Biomass disturbance threshold estimates (and confidence intervals) normalized to that site's two year flood as well as macroscale site covariates for sites that passed model diagnostic filtering steps (n = 130). These data are used to fit the posthoc bayesian regression models.

Column name | Description | Unit or Code explanation or date format | missing value code

XX | XX | XX | XX

###

Code: All of the following scripts were written and run using R and STAN in RStudio.

#
File name: 01_NWIS_RiverSelection.R
File description: Code to filter and select rivers based on the completeness and quality of their GPP time series from Appling et al. (2018). All URLs to download published, raw data files required by this script are provided in comments.
Category: Data Preparation
Scripting Language: R

#
File name: 02_StreamLight_processing.R
File description: Code to use GPP time series to filter existing surface light data estimates from Bernhardt et al. (2022). All URLs to download published, raw data files required by this script are provided in comments.
Category: Data Preparation
Scripting Language: R

#
File name: 03_DataSource_181rivers_StreamLight.R
File description: Code to compile and format time series for rivers with StreamLight PAR. This generates four separate data files that were used to fit models in parallel.
Category: Data Preparation
Scripting Language: R
Data Files Generated: list_181sites_Qmaxnorm_SavoySL.rds

#
File name: 04_Biomass_fit_model_pt1.R
File description: Code to compile data and call "Stan_ProductivityModel.stan" to fit latent biomass model. Note, this script was run on the University of Wyoming's Beartooth High Performance Computing Cluster so the final file directory included points to the UW server.
Category: Model Fit
Scripting Language: R

#
File name: 04_Biomass_fit_model_pt2.R
File description: Code to compile data and call "Stan_ProductivityModel.stan" to fit latent biomass model. Note, this script was run on the University of Wyoming's Beartooth High Performance Computing Cluster so the final file directory included points to the UW server.
Category: Model Fit
Scripting Language: R

#
File name: 04_Biomass_fit_model_pt3.R
File description: Code to compile data and call "Stan_ProductivityModel.stan" to fit latent biomass model. Note, this script was run on the University of Wyoming's Beartooth High Performance Computing Cluster so the final file directory included points to the UW server.
Category: Model Fit
Scripting Language: R

#
File name: 04_Biomass_fit_model_pt4.R
File description: Code to compile data and call "Stan_ProductivityModel.stan" to fit latent biomass model. Note, this script was run on the University of Wyoming's Beartooth High Performance Computing Cluster so the final file directory included points to the UW server.
Category: Model Fit
Scripting Language: R

#
File name: Stan_ProductivityModel.stan
File description: Code for the latent biomass time series model.
Category: Model Fit
Scripting Language: STAN

#
File name: 05_BeartoothOutput_processing.R
File description: Code to extract all iterations for daily and site-level parameter estimates.
Category: Model Output Preparation
Scripting Language: R
Data Files Generated: beartooth_181rivers_model_params_all_iterations_050823.rds, beartooth_181rivers_model_diags_050923.rds

#
File name: 06_Discharge_2yearflood.R
File description: Code to estimate the 2-year flood for each river using USGS daily discharge data.
Category: Data Preparation
Scripting Language: R

#
File name: 07_HUC2_delineation.R
File description: Code to delineate HUC2 values for each river.
Category: Data Preparation
Scripting Language: R

#
File name: 08_Nutrient_data_assembly.R
File description: Code to retrieve any available dissolved nutrient data (NO3, PO4) for the rivers included in this analysis using USGS nutrient data.
Category: Data Preparation
Scripting Language: R

#
File name: 09_parameter_filters.R
File description: Code to filter latent biomass model parameter estimates based on quality of model diagnostics and biologically reasonable values.
Category: QAQC
Scripting Language: R

#
File name: 10_Maximum_algal_yield.R
File description: Code to calculate maximum algal yield based on maximum growth rate and lambda parameter estimates.
Category: Data Preparation
Scripting Language: R

#
File name: 11_Qc_exceedances.R
File description: Code to calculate number of exceedances (total and annually) of the flow disturbance threshold of each river.
Category: Data Preparation
Scripting Language: R

#
File name: 12_Model_and_site_data_aggregation.R
File description: Code to create combined dataset of covariates to be included in post-hoc regression analyses for maximum algal yield (amax) and flow disturbance thresholds (Qc).
Category: Data Preparation
Scripting Language: R
Data Files Generated: amax_covariates_143sites_110723.rds, Qc_covariates_130sites_110723.rds

#
File name: 13_Posthoc_analyses.R
File description: Code to run regression analyses for maximum algal yield (amax) and flow disturbance thresholds (Qc) and generate accompanying figures. In addition, code to display values included in geomorphological threshold comparison (Table 1 of manuscript).
Category: Statistical Analyses
Scripting Language: R

#
File name: 14_Appendix_figures.R
File description: Code to generate appendix figures included in manuscript.
Category: Figures
Scripting Language: R

#
File name: 15_Reviewer_responses.R
File descript: Code for addressing reviewer comments including the following -- justification for normalizing to maximum discharge in a given record rather than the ten-year flood, additional figures demonstrating model results, justification for why time-series length did not influence latent biomass model parameters estimates nor posthoc regression results, investigation of latent biomass model fit with less informative priors, and examination of covariance of disturbance threshold (c) vs. sensitivity of disturbance (s) parameter estimates.
Category: Statistical Analyses/Figures
Scripting Language: R

#
File name: Stan_ProductivityModel_lessinformedpriors_R1.stan
File descript: Code for the latent biomass time series model with less informed priors to address reviewer comment.
Category: Model Fit
Scripting Language: STAN

End of metadata file.
